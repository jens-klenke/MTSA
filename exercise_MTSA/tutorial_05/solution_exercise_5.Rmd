---
title: 'Multivariate Time Series Analysis'
author: 'Dr. Yannick Hoga'
author2: 'Thilo Reinschlüssel'
subtitle: 'Solution Exercise Sheet 4'
semester: "Winter Term 2019/2020"
output:
  pdf_document:
    keep_tex: yes
    template: ../template.tex
    fig_caption: yes
    citation_package: biblatex
    number_sections: true
toc: true
lot: true
lof: true
graphics: true
linkcolor: black
urlcolor: black
citecolor: black
colorlinks: true
font: Times New Roman
fontsize: 12pt
geometry: lmargin = 2cm, rmargin = 2cm, tmargin = 2cm, bmargin = 2.5cm
classoption: a4paper
---

```{r , include=FALSE}
Sys.setlocale(locale = "English_United States.1252") ## English US Windows
knitr::opts_chunk$set(echo = TRUE)

source(here::here("packages/packages.R"))
```

# Exercise 1: Information Criteria

Prove Corollary 4.5 from Slide 4-7.


_Solution:_

From Theorem 4.4:

\begin{align*}
  C(l) = \log \left(\hat{\Sigma_a} (l) \right) + \dfrac{l}{T} \cdot c_T
\end{align*}


\begin{itemize}
  \item[i)] $\lim \limits_{T \rightarrow \infty} c_T \longrightarrow \infty$ 
  \item[ii)] $\lim \limits_{T \rightarrow \infty} \dfrac{c_T}{T} \longrightarrow 0$
\end{itemize}

If i) and ii) hold, $C(l)$ chooses the optimal/correct model. 

\begin{itemize}
  \item AIC: $c_T  = 2K^2$
  \begin{align*}
    \lim \limits_{T \rightarrow \infty} c_T & = 2 \ K^2 \centernot\implies \infty
  \end{align*}
  \begin{itemize}
    \item[$\Rightarrow$] not consistent
  \end{itemize}
  \item BIC: $c_T = \log(T)  \cdot K^2$
    \begin{align*}
    \lim \limits_{T \rightarrow \infty} c_T & = \log(T) K^2   \implies \infty \\
    \lim \limits_{T \rightarrow \infty} \dfrac{c_T}{T} & = \dfrac{\log(T)}{T} K^2 \implies 0 
  \end{align*}
  \begin{itemize}
    \item[$\Rightarrow$] consistent
  \end{itemize}
  \item HQ: $c_T = 2 \ \log(\log(T)) \ K^2$
  \begin{align*}
    \lim \limits_{T \rightarrow \infty} c_T & = 2 \ \log(\log(T)) \ K^2 \implies \infty  \\
    \lim \limits_{T \rightarrow \infty} \dfrac{c_T}{T} & = \dfrac{2 \ \log(\log(T)) \ K^2}{T} \implies 0 
  \end{align*}
  \begin{itemize}
    \item[$\Rightarrow$] consistent
  \end{itemize}
\end{itemize}


# Exercise 2: VAR(p): Data application
  
This exercise is concerned with finding an appropriate $\VAR(p)$ model for US macroeconomic data. You can find the dataset `us_macrodata.Rda` attached to this exercise sheet in the Moodle folder for this tutorial. Please use the `load` command to import the dataset from your directory into R.  There are 5 variables – CPI, Real GDP, the unemployment rate, general private investment and the debt-to-GDP ratio. All series have been sampled quarterly and were seasonally adjusted before downloaded from FRED.

```{r}
# loading data
load(file = here::here("exercise_MTSA/00_data/us_macrodata.Rda"))
# loading the MTS package
library(MTS)
```

\begin{itemize}
  \item[a.)] Plot all time series and judge which time series seem non-stationary. Proceed to compute growth rates of the non-stationary variables.
\end{itemize}

_Solution:_

```{r}
macmat <- data.matrix(us.macro_series)
plot.ts(macmat)
```

Every series except unemployment looks non-stationary. Regarding the debt-to-gdp ratio, this is surprising, but we better difference it as well.


```{r}
macdata <- cbind(diff(log(us.macro_series$cpi)), 
                 us.macro_series$unemprate[-(nrow(macmat))], 
                 diff(log(us.macro_series$rgdp)),
                 diff(log(us.macro_series$gp_investment)), 
                 diff(log(us.macro_series$debt_gdp)))

plot.ts(macdata)
```

Note that the last observation of 'unemp' was dropped for conformable length. Its last and not first due to the date information: measurements are always from the first day of a quarter.


\begin{itemize}
  \item[b.)] Perform a Ljung-Box test on the dataset. Does it look worthwhile to estimate a $\VAR(p)$
\end{itemize}

_Solution:_

```{r}
mq(x = macdata, lag = 20)
```

There is some correlation in the dataset. 


```{r}
mq(x = macdata[,-3], lag = 20)
```

Even without unemployment, there is some correlation in the dataset. 


\begin{itemize}
  \item[c.)] Determine the length of the time series. How many coefficients can be estimated and what does it mean for $K$ and $p$?
\end{itemize}

_Solution:_

We have $T \cdot K$ data points and we estimate $K^2$ parameters for each lag. For the intercept we estimate $K$ parameters. Which leads to the following condition for the maximal number of lag(s) $p$: 

$$ \dfrac{K \cdot (T -1)}{K^2} \geq p$$

```{r}
data_dim <- dim(macdata) 

Tmax <- data_dim[1] # observations
K <- data_dim[2] # variables
(max.p <- (Tmax * K - K) / K^2 )
```

`r floor(max.p)` lags can be estimated in addition to the intercept. 


\begin{itemize}
  \item[d.)] Consult the AIC, BIC and HQ to determine the optimal lag order for a $\VAR(p)$ model for the whole dataset. Plot the values of the three criteria for the lag orders p from 1 to 5 in one plot.
\end{itemize}

**Hint: ’VARorder’**

_Solution:_

```{r}
M <- 10 # maximal p 
VARorder(x = macdata, maxp = M)
# so it's p = 1, 2 or 4.....
var1to5.fit <- lapply(X = 1:M, function(i)
  VAR(x = macdata, include.mean = TRUE, p = i, output = FALSE))
var1to5.aic <- sapply(1:M, function(i) var1to5.fit[[i]]$aic)
var1to5.bic <- sapply(1:M, function(i) var1to5.fit[[i]]$bic)
var1to5.hq <- sapply(1:M, function(i) var1to5.fit[[i]]$hq)
plot(x = 1:M, y = var1to5.aic, type = "b",
     main = "Values of Information Criteria", xlab = "p",
     ylim = c( min(c(var1to5.aic, var1to5.bic, var1to5.hq)), 
               max(c(var1to5.aic, var1to5.bic, var1to5.hq)) ) )

points(x = 1:M, y = var1to5.bic, pch = 11, col = "red")
points(x = 1:M, y = var1to5.hq, col = "blue", pch = 25)
legend("topleft", legend = c("AIC", "BIC", "HQ"), 
       col = c("black", "red", "blue"), 
       pch = c(NA, 11, 25), lwd = c(2, NA, NA))
```


- AIC and HQ are flat around the minima $\Rightarrow$ no distinct optimum visible. 
- Conceivable reasons: persistence, omitted variables,  wrong functional form
  - The $\VAR$ may just work as an approximation
- BIC is the most conservative IC
- Mimima at:

\begin{align*}
p = 
  \begin{cases}
  1 & BIC \\
  2 & HQ \\
  4 & AIC
  \end{cases}
\end{align*}


